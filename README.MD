# Атака с нулевым кликом или как старый софт может вставить палки в колёса современному приложению

## Предыстория

### Важные обновления системы безопасности

Несмотря на то, что я являюсь активным пользователем техники Apple, я редко обращаю внимание на подробности обновлений, выпущенных яблочной корпорацией. Как бы там ни было, недавно я начал обращать внимание на названия обновлений и обнаружил следующее: летом 2023 года компания выпустила особые обновления безопасности, что меня крайне заинтересовало. Недолго думая, я начал изучать вопрос и узнал о таком интересном явлении, как атака с нулевым кликом. Что удивительно, эксплойту этого типа порядка 2 лет, а он всё никак не даёт покоя разработчикам. О нем я и расскажу далее. 

## Описание инцидента

### NSO Group. Pegasus.

После расследования в июле 2021 года в СМИ появилась информация о том, что шпионское ПО Pegasus используется авторитарными режимами для взлома телефонов (под iOS и Android) и слежки за правозащитниками, оппозиционными журналистами и юристами. Особенность была в том, что пользователь совершенно никак не мог узнать о взломе. Для заражения устройства достаточно было знать номер телефона жертвы. Таким образом, среди пострадавших были отмечены порядка 50 тысяч телефонных номеров, зарегистрированных в следующих странах:
- Азербайджан
- Бахрейн
- Венгрия
- Индия
- Казахстан
- Марокко
- Мексика
- Объединённые Арабские Эмираты
- Руанда
- Саудовская Аравия

С тех пор корпорация Apple стала усердно выпускать обновления безопасности для защиты от одного из самых технически сложных эксплойтов.

## Описание и объяснение причин, приведших к инциденту (какие решения были приняты и почему, какие обстоятельства сложились неблагоприятным образом)

### Атака с нулевым кликом

Атака с нулевым кликом - это вид уязвимостей, позволяющих злоумышленнику выполнять вредоносные действия без взаимодействия с пользователем. Такие атаки позволяют киберпреступнику получить контроль над приложением или устройством без применения социальной инженерии.

Для точного определения конкретизируем уязвимость согласно тому, как она была обнажена в iOS. 

### iMessage

Эксплойт осуществлялся с помощью приложения iMessage (нативное приложение продукции Apple). Для установления слежки за устройством достаточно было отправить особое графическое изображение растрового формата (`.gif`) на номер телефона (или AppleID) жертвы. Неблагоприятным обстоятельством оказалось то, что разработчики захотели зациклить проигрывание гифок, а обработку скрыть от пользователя (то есть обработка `.gif` начиналась до того, как пользователь увидит уведомление о сообщении).

В общем и целом, это и есть причина, по которой данный эксплойт можно назвать "атака с нулевым кликом", ведь о его активации пользователь не знает ничего от слова совсем. Зафиксировать наличие "шпиона" на устройстве можно исключительно с помощью специалиста.

### ImageIO API, CoreGraphics Framework и Xpdf toolkit

Для обработки `.gif` изображений код библиотеки ImageIO **автоматически определял формат переданного файла** (расширение файла игнорировалось). В качестве декодера выступало API фреймворка для рисования в iOS -- CoreGraphics PDF. Для парсинга же применялся доменный кодек изображений `JBIG2` (подробнее о процессе сжатия в следующей части доклада), чья реализация была взята из набора инструментов с **открытым исходным кодом** [Xpdf](https://www.xpdfreader.com/).

Использование кода парсера из легаси опенсорс набора инструментов нельзя назвать грубой ошибкой или ленью, поскольку данный код был написан во времена серьезных требований к памяти (конец 1990-х), а значит крайне хорошо сжимал изображения.

В совокупности автоопределение формата файла и уязвимый код парсера CodeGraphics JBIG2 позволили в качестве файла передать поддельный `.gif` (содержащий в себе особый `.pdf`), который для побега из "песочницы" посредством сложных манипуляций переполнял буфер растрового изображения, эмулировал архитектуру компьютера и определял собственные сценарии.

## Описание технических деталей (побольше визуализации <u>систем</u>)

todo

## Принятые меры в связи с инцидентом (побольше визуализации <u>процессов</u>)

todo

## Обобщение проблемы

todo

## Мораль и выводы, сделанные индустрией (как изменились практики компьютерных систем)

todo

---

> **Выполнил**
>> Тучков Максим Русланович
> 
> **Группа**
>> P33121
> 
> **Преподаватель практики**
>> Горбачёв Ярослав Георгиевич
> 
> **Лектор**:
>> [Пенской Александр Владимирович](https://github.com/ryukzak)
> 
> **Список источников**:
>> 1. https://googleprojectzero.blogspot.com/2021/12/a-deep-dive-into-nso-zero-click.html
>> 2. https://en.wikipedia.org/wiki/JBIG2
>> 3. https://nplus1.ru/news/2021/12/18/forcedentry
>> 4. https://googleprojectzero.blogspot.com/2020/04/fuzzing-imageio.html
>> 5. https://www.xpdfreader.com/download.html
>> 6. https://support.apple.com/en-us/HT212807
>> 7. http://www.dkriesel.com/en/blog/2013/0802_xerox-workcentres_are_switching_written_numbers_when_scanning
>> 8. https://crast.net/345665/ongoing-zero-click-iphone-spyware-attack-exposed-in-imessage/
>> 9. https://www.kaspersky.ru/resource-center/definitions/zero-day-exploit
>> 10. https://www.kaspersky.ru/resource-center/definitions/what-is-zero-click-malware
>> 11. https://www.securitylab.ru/news/538630.php
>> 12. https://kod.ru/operation-triangulation-interview
>> 13. https://securelist.com/triangledb-triangulation-implant/110050/
>> 14. https://securelist.ru/trng-2023/
>> 15. https://securelist.ru/operation-triangulation/107470/
>> 16. https://habr.com/ru/news/743140/
>> 17. https://habr.com/ru/news/743268/
>> 18. https://habr.com/ru/articles/429602/
>
> Ссылка на презентацию:
>> https://docs.google.com/presentation/d/1oxQBI1k8BPWqDZkAppSXk87uJE-e102r74HFHjmC6w4/edit?usp=sharing
